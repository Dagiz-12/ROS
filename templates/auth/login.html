{% extends "base_auth.html" %} {% block title %}Login - TableSync{% endblock %}
{% block content %}
<div
  class="min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-white py-12 px-4 sm:px-6 lg:px-8"
>
  <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-2xl shadow-xl">
    <!-- Header -->
    <div class="text-center">
      <div class="flex justify-center mb-6">
        <div class="bg-red-600 text-white p-4 rounded-xl">
          <i class="fas fa-utensils text-3xl"></i>
        </div>
      </div>

      <h2 class="mt-2 text-3xl font-extrabold text-gray-900 playfair">
        Welcome to TableSync
      </h2>
      <p class="mt-2 text-sm text-gray-600">
        Please sign in to access your restaurant dashboard
      </p>
    </div>

    <!-- Login Form -->
    <form class="mt-8 space-y-6" id="login-form">
      {% csrf_token %}

      <!-- Role Selection (Optional - now just visual) -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Select your interface:
        </label>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
          <button
            type="button"
            onclick="selectInterface('waiter')"
            id="interface-waiter"
            class="interface-btn flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition"
          >
            <i class="fas fa-user-tie text-2xl text-blue-500 mb-2"></i>
            <span class="text-sm font-medium">Waiter</span>
          </button>

          <button
            type="button"
            onclick="selectInterface('chef')"
            id="interface-chef"
            class="interface-btn flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition"
          >
            <i class="fas fa-utensils text-2xl text-green-500 mb-2"></i>
            <span class="text-sm font-medium">Chef</span>
          </button>

          <button
            type="button"
            onclick="selectInterface('cashier')"
            id="interface-cashier"
            class="interface-btn flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition"
          >
            <i class="fas fa-cash-register text-2xl text-purple-500 mb-2"></i>
            <span class="text-sm font-medium">Cashier</span>
          </button>

          <button
            type="button"
            onclick="selectInterface('manager')"
            id="interface-manager"
            class="interface-btn flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-xl hover:border-red-500 hover:bg-red-50 transition"
          >
            <i class="fas fa-user-tie text-2xl text-red-500 mb-2"></i>
            <span class="text-sm font-medium">Manager</span>
          </button>

          <button
            type="button"
            onclick="selectInterface('admin')"
            id="interface-admin"
            class="interface-btn flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-xl hover:border-yellow-500 hover:bg-yellow-50 transition"
          >
            <i class="fas fa-user-shield text-2xl text-yellow-500 mb-2"></i>
            <span class="text-sm font-medium">Admin</span>
          </button>
        </div>
        <div
          id="interface-hint"
          class="text-xs text-gray-500 text-center hidden"
        >
          <i class="fas fa-info-circle mr-1"></i>
          <span>Role will be auto-detected from your credentials</span>
        </div>
      </div>

      <!-- Username/Email Field -->
      <div>
        <label for="username" class="block text-sm font-medium text-gray-700">
          Username or Email
        </label>
        <div class="mt-1 relative">
          <div
            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
          >
            <i class="fas fa-user text-gray-400"></i>
          </div>
          <input
            id="username"
            name="username"
            type="text"
            required
            class="appearance-none rounded-lg relative block w-full pl-10 pr-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
            placeholder="Enter your username or email"
          />
        </div>
      </div>

      <!-- Password Field -->
      <div>
        <label for="password" class="block text-sm font-medium text-gray-700">
          Password
        </label>
        <div class="mt-1 relative">
          <div
            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
          >
            <i class="fas fa-lock text-gray-400"></i>
          </div>
          <input
            id="password"
            name="password"
            type="password"
            required
            class="appearance-none rounded-lg relative block w-full pl-10 pr-10 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
            placeholder="Enter your password"
          />
          <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
            <button
              type="button"
              onclick="togglePassword()"
              class="text-gray-400 hover:text-gray-600"
            >
              <i id="password-icon" class="fas fa-eye"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Remember Me & Forgot Password -->
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <input
            id="remember-me"
            name="remember-me"
            type="checkbox"
            class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"
          />
          <label for="remember-me" class="ml-2 block text-sm text-gray-700">
            Remember me
          </label>
        </div>

        <div class="text-sm">
          <a href="#" class="font-medium text-red-600 hover:text-red-500">
            Forgot your password?
          </a>
        </div>
      </div>

      <!-- Error Message -->
      <div
        id="error-message"
        class="hidden p-3 bg-red-50 border border-red-200 text-red-600 rounded-lg text-sm"
      >
        <i class="fas fa-exclamation-circle mr-2"></i>
        <span id="error-text">Invalid username or password</span>
      </div>

      <!-- Success Message -->
      <div
        id="success-message"
        class="hidden p-3 bg-green-50 border border-green-200 text-green-600 rounded-lg text-sm"
      >
        <i class="fas fa-check-circle mr-2"></i>
        <span id="success-text">Login successful! Redirecting...</span>
      </div>

      <!-- Submit Button -->
      <div>
        <button
          type="submit"
          id="submit-btn"
          class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span class="absolute left-0 inset-y-0 flex items-center pl-3">
            <i class="fas fa-sign-in-alt"></i>
          </span>
          <span id="submit-text">Sign in</span>
          <div id="loading-spinner" class="hidden ml-2">
            <div
              class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"
            ></div>
          </div>
        </button>
      </div>
    </form>

    <!-- Demo Credentials -->
    <div class="mt-8 pt-6 border-t border-gray-200">
      <h3 class="text-sm font-medium text-gray-700 mb-3">Demo Credentials</h3>
      <div class="space-y-2">
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-600">Waiter:</span>
          <span class="font-mono bg-gray-100 px-2 py-1 rounded"
            >waiter1 / waiter123</span
          >
        </div>
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-600">Chef:</span>
          <span class="font-mono bg-gray-100 px-2 py-1 rounded"
            >chef1 / chef123</span
          >
        </div>
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-600">Cashier:</span>
          <span class="font-mono bg-gray-100 px-2 py-1 rounded"
            >cashier1 / cashier123</span
          >
        </div>
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-600">Manager:</span>
          <span class="font-mono bg-gray-100 px-2 py-1 rounded"
            >manager1 / manager123</span
          >
        </div>
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-600">Admin:</span>
          <span class="font-mono bg-gray-100 px-2 py-1 rounded"
            >admin / admin123</span
          >
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-3">
        <i class="fas fa-lightbulb mr-1"></i>
        Your role will be automatically detected from your username
      </p>
    </div>

    <!-- QR Access Info -->
    <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <div class="flex items-start">
        <i class="fas fa-qrcode text-blue-500 mt-1 mr-3"></i>
        <div>
          <h4 class="text-sm font-medium text-blue-800">Customer Access</h4>
          <p class="text-xs text-blue-600 mt-1">
            Customers don't need to login. They can scan the QR code on their
            table to access the menu directly.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Load auth manager -->
<script src="/static/js/auth-manager.js"></script>

<script>
  // Auto-select interface based on username
  let selectedInterface = "";

  function selectInterface(interface) {
    selectedInterface = interface;

    // Reset all buttons
    document.querySelectorAll(".interface-btn").forEach((btn) => {
      btn.classList.remove(
        "border-blue-600",
        "bg-blue-50",
        "border-green-600",
        "bg-green-50",
        "border-purple-600",
        "bg-purple-50",
        "border-red-600",
        "bg-red-50",
        "border-yellow-600",
        "bg-yellow-50"
      );
      btn.classList.add("border-gray-200");
    });

    // Highlight selected interface
    const btn = document.getElementById(`interface-${interface}`);
    const interfaceColors = {
      waiter: ["border-blue-600", "bg-blue-50"],
      chef: ["border-green-600", "bg-green-50"],
      cashier: ["border-purple-600", "bg-purple-50"],
      manager: ["border-red-600", "bg-red-50"],
      admin: ["border-yellow-600", "bg-yellow-50"],
    };

    btn.classList.remove("border-gray-200");
    btn.classList.add(...interfaceColors[interface]);

    // Show hint
    document.getElementById("interface-hint").classList.remove("hidden");

    // Update username placeholder hint
    const usernameInput = document.getElementById("username");
    const roleExamples = {
      waiter: "waiter1",
      chef: "chef1",
      cashier: "cashier1",
      manager: "manager1",
      admin: "admin",
    };
    usernameInput.placeholder = `e.g., ${roleExamples[interface]}`;
  }

  // Toggle password visibility
  function togglePassword() {
    const passwordInput = document.getElementById("password");
    const icon = document.getElementById("password-icon");

    if (passwordInput.type === "password") {
      passwordInput.type = "text";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    } else {
      passwordInput.type = "password";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    }
  }

  // Show/hide messages
  function showError(message) {
    const errorDiv = document.getElementById("error-message");
    const errorText = document.getElementById("error-text");
    const successDiv = document.getElementById("success-message");

    successDiv.classList.add("hidden");
    errorText.textContent = message;
    errorDiv.classList.remove("hidden");

    // Auto-hide after 5 seconds
    setTimeout(() => {
      errorDiv.classList.add("hidden");
    }, 5000);
  }

  function showSuccess(message) {
    const errorDiv = document.getElementById("error-message");
    const successDiv = document.getElementById("success-message");
    const successText = document.getElementById("success-text");

    errorDiv.classList.add("hidden");
    successText.textContent = message;
    successDiv.classList.remove("hidden");
  }

  // Update interface based on username input
  document.getElementById("username").addEventListener("input", function (e) {
    const username = e.target.value.toLowerCase();

    // Auto-detect interface based on username
    if (username.includes("waiter")) {
      selectInterface("waiter");
    } else if (username.includes("chef")) {
      selectInterface("chef");
    } else if (username.includes("cashier")) {
      selectInterface("cashier");
    } else if (username.includes("manager")) {
      selectInterface("manager");
    } else if (username.includes("admin")) {
      selectInterface("admin");
    }
  });

  // Handle form submission
  document
    .getElementById("login-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;

      if (!username || !password) {
        showError("Please enter both username and password");
        return;
      }

      // UI Loading state
      const submitBtn = document.getElementById("submit-btn");
      const submitText = document.getElementById("submit-text");
      const loadingSpinner = document.getElementById("loading-spinner");

      submitBtn.disabled = true;
      submitText.textContent = "Signing in...";
      loadingSpinner.classList.remove("hidden");

      try {
        const result = await window.authManager.login(username, password);

        if (result.success) {
          showSuccess("Login successful! Redirecting...");

          // DEBUG: Check localStorage before redirect
          console.log("Before redirect - checking localStorage:");
          console.log(
            "Token:",
            localStorage.getItem("access_token") ? "Exists" : "Missing"
          );
          console.log("Role:", localStorage.getItem("user_role"));

          // Wait a moment to ensure localStorage is updated
          setTimeout(() => {
            console.log("Redirecting now...");
            window.authManager.redirectBasedOnRole();
          }, 1000); // Give it 1 second
        } else {
          showError(
            result.error || "Login failed. Please check your credentials."
          );

          // Reset UI
          submitBtn.disabled = false;
          submitText.textContent = "Sign in";
          loadingSpinner.classList.add("hidden");
        }
      } catch (error) {
        showError("An unexpected error occurred. Please try again.");
        console.error("Login error:", error);

        // Reset UI
        submitBtn.disabled = false;
        submitText.textContent = "Sign in";
        loadingSpinner.classList.add("hidden");
      }
    });

  // Auto-select based on URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const interfaceParam = urlParams.get("interface");
  if (
    interfaceParam &&
    ["waiter", "chef", "cashier", "manager", "admin"].includes(interfaceParam)
  ) {
    selectInterface(interfaceParam);
  }

  // Check if user is already logged in
  document.addEventListener("DOMContentLoaded", function () {
    const token = localStorage.getItem("access_token");
    if (token) {
      // Try to verify token and redirect if valid
      window.authManager.verifyToken().then((isValid) => {
        if (isValid) {
          window.authManager.redirectBasedOnRole();
        }
      });
    }
  });
</script>

<style>
  .playfair {
    font-family: "Playfair Display", serif;
  }

  .interface-btn {
    transition: all 0.3s ease;
  }

  .interface-btn:hover {
    transform: translateY(-2px);
  }

  @media (max-width: 640px) {
    .interface-btn {
      padding: 12px;
    }

    .interface-btn i {
      font-size: 1.5rem;
    }
  }
</style>
{% endblock %}
