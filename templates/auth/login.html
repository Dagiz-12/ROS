{% extends "base_auth.html" %} {% block title %}Login - TableSync{% endblock %}
{% block content %}
<div
  class="min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-white py-12 px-4 sm:px-6 lg:px-8"
>
  <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-2xl shadow-xl">
    <div class="text-center">
      <div class="flex justify-center mb-6">
        <div class="bg-red-600 text-white p-4 rounded-xl">
          <i class="fas fa-utensils text-3xl"></i>
        </div>
      </div>

      <h2 class="mt-2 text-3xl font-extrabold text-gray-900 playfair">
        Welcome to TableSync
      </h2>
      <p class="mt-2 text-sm text-gray-600">
        Please sign in to access your restaurant dashboard
      </p>
    </div>

    <!-- Login Form -->
    <form class="mt-8 space-y-6" id="login-form">
      {% csrf_token %}

      <!-- Role Selection -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          I am signing in as:
        </label>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
          <button
            type="button"
            onclick="selectRole('waiter')"
            id="role-waiter"
            class="role-btn flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition"
          >
            <i class="fas fa-user-tie text-2xl text-blue-500 mb-2"></i>
            <span class="text-sm font-medium">Waiter</span>
          </button>

          <button
            type="button"
            onclick="selectRole('chef')"
            id="role-chef"
            class="role-btn flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition"
          >
            <i class="fas fa-utensils text-2xl text-green-500 mb-2"></i>
            <span class="text-sm font-medium">Chef</span>
          </button>

          <button
            type="button"
            onclick="selectRole('cashier')"
            id="role-cashier"
            class="role-btn flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition"
          >
            <i class="fas fa-cash-register text-2xl text-purple-500 mb-2"></i>
            <span class="text-sm font-medium">Cashier</span>
          </button>

          <button
            type="button"
            onclick="selectRole('manager')"
            id="role-manager"
            class="role-btn flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-xl hover:border-red-500 hover:bg-red-50 transition"
          >
            <i class="fas fa-user-tie text-2xl text-red-500 mb-2"></i>
            <span class="text-sm font-medium">Manager</span>
          </button>

          <button
            type="button"
            onclick="selectRole('admin')"
            id="role-admin"
            class="role-btn flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-xl hover:border-yellow-500 hover:bg-yellow-50 transition"
          >
            <i class="fas fa-user-shield text-2xl text-yellow-500 mb-2"></i>
            <span class="text-sm font-medium">Admin</span>
          </button>
        </div>
        <input type="hidden" id="selected-role" name="role" value="" />
      </div>

      <!-- Username/Email Field -->
      <div>
        <label for="username" class="block text-sm font-medium text-gray-700">
          Username or Email
        </label>
        <div class="mt-1 relative">
          <div
            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
          >
            <i class="fas fa-user text-gray-400"></i>
          </div>
          <input
            id="username"
            name="username"
            type="text"
            required
            class="appearance-none rounded-lg relative block w-full pl-10 pr-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
            placeholder="Enter your username or email"
          />
        </div>
      </div>

      <!-- Password Field -->
      <div>
        <label for="password" class="block text-sm font-medium text-gray-700">
          Password
        </label>
        <div class="mt-1 relative">
          <div
            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
          >
            <i class="fas fa-lock text-gray-400"></i>
          </div>
          <input
            id="password"
            name="password"
            type="password"
            required
            class="appearance-none rounded-lg relative block w-full pl-10 pr-10 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
            placeholder="Enter your password"
          />
          <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
            <button
              type="button"
              onclick="togglePassword()"
              class="text-gray-400 hover:text-gray-600"
            >
              <i id="password-icon" class="fas fa-eye"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Remember Me & Forgot Password -->
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <input
            id="remember-me"
            name="remember-me"
            type="checkbox"
            class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"
          />
          <label for="remember-me" class="ml-2 block text-sm text-gray-700">
            Remember me
          </label>
        </div>

        <div class="text-sm">
          <a href="#" class="font-medium text-red-600 hover:text-red-500">
            Forgot your password?
          </a>
        </div>
      </div>

      <!-- Error Message -->
      <div
        id="error-message"
        class="hidden p-3 bg-red-50 border border-red-200 text-red-600 rounded-lg text-sm"
      >
        <i class="fas fa-exclamation-circle mr-2"></i>
        <span id="error-text">Invalid username or password</span>
      </div>

      <!-- Submit Button -->
      <div>
        <button
          type="submit"
          id="submit-btn"
          class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition"
        >
          <span class="absolute left-0 inset-y-0 flex items-center pl-3">
            <i class="fas fa-sign-in-alt"></i>
          </span>
          Sign in
          <span id="loading-spinner" class="hidden ml-2">
            <i class="fas fa-spinner fa-spin"></i>
          </span>
        </button>
      </div>
    </form>

    <!-- Demo Credentials -->
    <div class="mt-8 pt-6 border-t border-gray-200">
      <h3 class="text-sm font-medium text-gray-700 mb-3">Demo Credentials</h3>
      <div class="space-y-2">
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-600">Waiter:</span>
          <span class="font-mono bg-gray-100 px-2 py-1 rounded"
            >waiter1 / waiter123</span
          >
        </div>
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-600">Chef:</span>
          <span class="font-mono bg-gray-100 px-2 py-1 rounded"
            >chef1 / chef123</span
          >
        </div>
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-600">Cashier:</span>
          <span class="font-mono bg-gray-100 px-2 py-1 rounded"
            >cashier1 / cashier123</span
          >
        </div>
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-600">Manager:</span>
          <span class="font-mono bg-gray-100 px-2 py-1 rounded"
            >manager1 / manager123</span
          >
        </div>
        <div class="flex items-center justify-between text-sm">
          <span class="text-gray-600">Admin:</span>
          <span class="font-mono bg-gray-100 px-2 py-1 rounded"
            >admin / admin123</span
          >
        </div>
      </div>
    </div>

    <!-- QR Access Info -->
    <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <div class="flex items-start">
        <i class="fas fa-qrcode text-blue-500 mt-1 mr-3"></i>
        <div>
          <h4 class="text-sm font-medium text-blue-800">Customer Access</h4>
          <p class="text-xs text-blue-600 mt-1">
            Customers don't need to login. They can scan the QR code on their
            table to access the menu directly.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie("csrftoken");

  // Form submission - FIXED VERSION
  document
    .getElementById("login-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = {
        username: document.getElementById("username").value,
        password: document.getElementById("password").value,
        role: document.getElementById("selected-role").value,
      };

      if (!formData.role) {
        showError("Please select your role first");
        return;
      }

      // Show loading
      const submitBtn = document.getElementById("submit-btn");
      const loadingSpinner = document.getElementById("loading-spinner");
      submitBtn.disabled = true;
      loadingSpinner.classList.remove("hidden");

      try {
        // FIXED: Use proper headers with CSRF token
        const response = await fetch("/api/auth/login/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken, // Use the token we got from cookie
          },
          body: JSON.stringify(formData),
        });

        const data = await response.json();

        if (response.ok) {
          // Store token in localStorage for API calls
          localStorage.setItem("access_token", data.token);
          localStorage.setItem("user_role", data.user.role);
          localStorage.setItem("username", data.user.username);

          // Also store in sessionStorage for immediate use
          sessionStorage.setItem("logged_in", "true");
          sessionStorage.setItem("user_role", data.user.role);

          // Redirect based on role
          const redirectUrls = {
            waiter: "/waiter/dashboard/",
            chef: "/chef/dashboard/",
            cashier: "/cashier/dashboard/",
            manager: "/restaurant-admin/dashboard/",
            admin: "/admin/",
          };

          window.location.href =
            redirectUrls[data.user.role] || "/waiter/dashboard/";
        } else {
          showError(data.detail || data.message || "Invalid credentials");
        }
      } catch (error) {
        console.error("Login error:", error);
        showError("Network error. Please try again.");
      } finally {
        submitBtn.disabled = false;
        loadingSpinner.classList.add("hidden");
      }
    });

  let selectedRole = "";

  // Role selection
  function selectRole(role) {
    selectedRole = role;

    // Reset all buttons
    document.querySelectorAll(".role-btn").forEach((btn) => {
      btn.classList.remove(
        "border-2",
        "border-red-600",
        "bg-red-50",
        "border-blue-600",
        "bg-blue-50",
        "border-green-600",
        "bg-green-50",
        "border-purple-600",
        "bg-purple-50",
        "border-yellow-600",
        "bg-yellow-50"
      );
      btn.classList.add("border-gray-200");
    });

    // Highlight selected role
    const btn = document.getElementById(`role-${role}`);
    const roleColors = {
      waiter: ["border-blue-600", "bg-blue-50"],
      chef: ["border-green-600", "bg-green-50"],
      cashier: ["border-purple-600", "bg-purple-50"],
      manager: ["border-red-600", "bg-red-50"],
      admin: ["border-yellow-600", "bg-yellow-50"],
    };

    btn.classList.remove("border-gray-200");
    btn.classList.add(...roleColors[role]);

    // Update hidden input
    document.getElementById("selected-role").value = role;

    // Update username placeholder
    const usernameInput = document.getElementById("username");
    const roleExamples = {
      waiter: "waiter1, waiter2, ...",
      chef: "chef1, chef2, ...",
      cashier: "cashier1, cashier2, ...",
      manager: "manager1, manager2, ...",
      admin: "admin",
    };
    usernameInput.placeholder = `Enter your username (e.g., ${roleExamples[role]})`;
  }

  // Toggle password visibility
  function togglePassword() {
    const passwordInput = document.getElementById("password");
    const icon = document.getElementById("password-icon");

    if (passwordInput.type === "password") {
      passwordInput.type = "text";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    } else {
      passwordInput.type = "password";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    }
  }

  // Form submission
  document
    .getElementById("login-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      // Validate role selection
      if (!selectedRole) {
        showError("Please select your role first");
        return;
      }

      const formData = {
        username: document.getElementById("username").value,
        password: document.getElementById("password").value,
        role: selectedRole,
      };

      // Show loading
      const submitBtn = document.getElementById("submit-btn");
      const loadingSpinner = document.getElementById("loading-spinner");
      submitBtn.disabled = true;
      loadingSpinner.classList.remove("hidden");

      try {
        const response = await fetch("/api/auth/login/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
              .value,
          },
          body: JSON.stringify(formData),
        });

        const data = await response.json();

        if (response.ok) {
          // Store token
          localStorage.setItem("access_token", data.access);
          localStorage.setItem("refresh_token", data.refresh);
          localStorage.setItem("user_role", data.role);
          localStorage.setItem("username", data.username);

          // Redirect based on role
          const redirectUrls = {
            waiter: "/api/tables/waiter/dashboard/",
            chef: "/api/tables/chef/dashboard/",
            cashier: "/api/tables/cashier/dashboard/",
            manager: "/restaurant-admin/dashboard/",
            admin: "/admin/",
          };

          window.location.href =
            redirectUrls[data.role] || "/api/tables/waiter/dashboard/";
        } else {
          showError(data.detail || "Invalid credentials");
        }
      } catch (error) {
        showError("Network error. Please try again.");
        console.error("Login error:", error);
      } finally {
        submitBtn.disabled = false;
        loadingSpinner.classList.add("hidden");
      }
    });

  function showError(message) {
    const errorDiv = document.getElementById("error-message");
    const errorText = document.getElementById("error-text");

    errorText.textContent = message;
    errorDiv.classList.remove("hidden");

    // Auto-hide after 5 seconds
    setTimeout(() => {
      errorDiv.classList.add("hidden");
    }, 5000);
  }

  // Auto-select role based on URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const roleParam = urlParams.get("role");
  if (
    roleParam &&
    ["waiter", "chef", "cashier", "manager", "admin"].includes(roleParam)
  ) {
    selectRole(roleParam);
  }
</script>

<style>
  .playfair {
    font-family: "Playfair Display", serif;
  }

  .role-btn.selected {
    transform: scale(0.98);
  }
</style>
{% endblock %}
