{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <title>New Order - Waiter Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="{% static 'js/auth-manager.js' %}"></script>
    <script src="{% static 'js/waiter-new-order.js' %}" defer></script>
    <style>
      /* Tablet and mobile optimizations */
      @media (max-width: 640px) {
        .safe-area-padding {
          padding-left: env(safe-area-inset-left);
          padding-right: env(safe-area-inset-right);
          padding-bottom: env(safe-area-inset-bottom);
        }
        .mobile-full-height {
          height: calc(100vh - env(safe-area-inset-bottom));
        }
      }

      /* Prevent text selection on interactive elements */
      .no-select {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      /* Better touch targets */
      button,
      input,
      .menu-item,
      .table-btn {
        min-height: 44px; /* Apple HIG minimum touch target */
      }

      /* Hide number input spinners */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
    </style>
  </head>
  <body class="bg-gray-50 safe-area-padding">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-40">
      <div class="container mx-auto px-3 md:px-4 py-3">
        <div class="flex justify-between items-center">
          <div class="flex items-center space-x-2 md:space-x-3">
            <a
              href="{% url 'waiter-dashboard' %}"
              class="text-gray-600 hover:text-red-600 p-2 -ml-2 rounded-full hover:bg-gray-100 transition-colors duration-200"
            >
              <i class="fas fa-arrow-left text-lg"></i>
            </a>
            <i class="fas fa-plus-circle text-xl md:text-2xl text-red-600"></i>
            <div>
              <h1 class="text-lg md:text-xl font-bold truncate">New Order</h1>
              <p class="text-xs md:text-sm text-gray-600 truncate">
                {{ user.get_full_name|default:user.username }}
              </p>
            </div>
          </div>
          <div class="flex items-center space-x-2 md:space-x-3">
            <span
              class="bg-red-100 text-red-800 px-2 md:px-3 py-1 rounded-full text-xs md:text-sm"
            >
              {{ user_role|title }}
            </span>
            <button
              id="cart-preview"
              class="relative bg-red-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-red-700 active:bg-red-800 transition-colors duration-200 no-select"
            >
              <i class="fas fa-shopping-cart mr-1 md:mr-2"></i>
              <span id="cart-count" class="font-bold">0</span>
              <span class="hidden md:inline"> items</span>
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-3 md:px-4 py-4 md:py-6">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
        <!-- Left Column: Table Selection & Menu -->
        <div class="lg:col-span-2 space-y-4 md:space-y-6">
          <!-- Table Selection -->
          <section class="bg-white rounded-xl shadow-sm p-3 md:p-4">
            <h2
              class="text-base md:text-lg font-bold mb-3 md:mb-4 flex items-center"
            >
              <i class="fas fa-table mr-2 text-red-600"></i>
              Select Table
            </h2>

            <div
              class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2 md:gap-3 mb-4"
              id="tables-container"
            >
              <div class="col-span-full text-center py-8 text-gray-500">
                <div
                  class="spinner w-10 h-10 border-3 border-red-600 border-t-transparent rounded-full animate-spin mx-auto mb-3"
                ></div>
                <p class="text-sm">Loading tables...</p>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-user mr-1 text-gray-400"></i>
                Customer Name (Optional)
              </label>
              <input
                type="text"
                id="customer-name"
                class="w-full border border-gray-300 rounded-lg px-3 md:px-4 py-2 md:py-2.5 focus:ring-2 focus:ring-red-500 focus:border-transparent placeholder:text-gray-400 text-sm md:text-base"
                placeholder="Enter customer name"
                autocapitalize="words"
                autocomplete="name"
              />
            </div>
          </section>

          <!-- Menu Section -->
          <section class="bg-white rounded-xl shadow-sm p-3 md:p-4">
            <div class="flex justify-between items-center mb-3 md:mb-4">
              <h2 class="text-base md:text-lg font-bold flex items-center">
                <i class="fas fa-utensils mr-2 text-red-600"></i>
                Menu
              </h2>

              <!-- Search Input -->
              <div class="relative w-32 md:w-48">
                <input
                  type="text"
                  id="menu-search"
                  class="w-full border border-gray-300 rounded-lg px-3 py-2 pl-8 md:pl-9 focus:ring-2 focus:ring-red-500 focus:border-transplaceholder:text-gray-400 text-sm"
                  placeholder="Search..."
                  autocapitalize="none"
                  autocomplete="off"
                />
                <i
                  class="fas fa-search absolute left-2.5 md:left-3 top-2.5 text-gray-400 text-sm"
                ></i>
              </div>
            </div>

            <!-- Categories -->
            <div class="mb-4">
              <div
                class="flex space-x-2 overflow-x-auto scrollbar-hide pb-2 -mx-1 px-1"
                id="categories-container"
              >
                <!-- Categories will be loaded here -->
              </div>
            </div>

            <!-- Menu Items -->
            <div
              id="menu-items-container"
              class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4"
            >
              <!-- Menu items will be loaded here -->
              <div class="col-span-full text-center py-12 text-gray-500">
                <div
                  class="spinner w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"
                ></div>
                <p class="text-base">Loading menu...</p>
              </div>
            </div>
          </section>
        </div>

        <!-- Right Column: Order Cart (Sticky on desktop) -->
        <div class="lg:col-span-1">
          <div
            class="bg-white rounded-xl shadow-sm sticky top-20 lg:top-24 mobile-full-height flex flex-col"
          >
            <!-- Cart Header -->
            <div class="p-3 md:p-4 border-b">
              <h2 class="text-lg md:text-xl font-bold mb-1">Order Summary</h2>
              <div class="text-sm text-gray-600" id="table-selection">
                <span class="text-gray-400">No table selected</span>
              </div>
            </div>

            <!-- Cart Items (Scrollable) -->
            <div
              class="flex-1 overflow-y-auto p-3 md:p-4"
              id="cart-items-container"
            >
              <div class="text-center py-12 text-gray-500">
                <i class="fas fa-shopping-cart text-3xl md:text-4xl mb-3"></i>
                <p class="text-base md:text-lg">Cart is empty</p>
                <p class="text-sm md:text-base">Add items from the menu</p>
              </div>
            </div>

            <!-- Order Summary & Actions (Sticky at bottom) -->
            <div class="p-3 md:p-4 border-t bg-gray-50">
              <!-- Price Breakdown -->
              <div class="space-y-2 mb-3 md:mb-4">
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">Subtotal</span>
                  <span id="cart-subtotal" class="font-medium">ETB 0.00</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">Tax (15%)</span>
                  <span id="cart-tax" class="font-medium">ETB 0.00</span>
                </div>
                <div class="border-t pt-2 mt-2">
                  <div
                    class="flex justify-between font-bold text-base md:text-lg"
                  >
                    <span>Total</span>
                    <span id="cart-total" class="text-red-600">ETB 0.00</span>
                  </div>
                </div>
              </div>

              <!-- Special Instructions -->
              <div class="mb-3 md:mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-sticky-note mr-1 text-gray-400"></i>
                  Special Instructions
                </label>
                <textarea
                  id="special-instructions"
                  class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent placeholder:text-gray-400 text-sm resize-none"
                  rows="2"
                  placeholder="Any special requests or notes..."
                  maxlength="500"
                ></textarea>
                <div class="text-right text-xs text-gray-400 mt-1">
                  <span id="char-count">0</span>/500
                </div>
              </div>

              <!-- Order Buttons -->
              <div class="space-y-2">
                <button
                  id="submit-order-btn"
                  class="w-full bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 active:bg-red-800 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200 no-select"
                >
                  <i class="fas fa-paper-plane mr-2"></i>
                  Submit to Kitchen
                </button>

                <div class="grid grid-cols-2 gap-2">
                  <button
                    onclick="window.waiterNewOrder.clearCart()"
                    class="border border-gray-300 text-gray-700 py-2.5 rounded-lg font-bold hover:bg-gray-50 active:bg-gray-100 transition-colors duration-200 no-select"
                  >
                    <i class="fas fa-trash mr-2"></i>
                    Clear
                  </button>
                  <a
                    href="{% url 'waiter-orders' %}"
                    class="border border-gray-300 text-gray-700 py-2.5 rounded-lg font-bold hover:bg-gray-50 active:bg-gray-100 transition-colors duration-200 no-select text-center"
                  >
                    <i class="fas fa-list mr-2"></i>
                    Orders
                  </a>
                </div>
              </div>

              <!-- Keyboard shortcut hint -->
              <div
                class="text-center text-xs text-gray-400 mt-3 hidden md:block"
              >
                <kbd class="px-2 py-1 bg-gray-100 rounded">Ctrl</kbd> +
                <kbd class="px-2 py-1 bg-gray-100 rounded">Enter</kbd> to submit
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Toast Container (if not provided by auth-manager) -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Quick Actions Bar (Mobile only) -->
    <div
      class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg safe-area-padding"
    >
      <div class="container mx-auto px-3 py-2">
        <div class="flex justify-between items-center">
          <div class="text-sm">
            <span id="mobile-cart-count" class="font-bold">0</span> items
            <span id="mobile-cart-total" class="text-red-600 font-bold ml-2"
              >ETB 0.00</span
            >
          </div>
          <button
            id="mobile-submit-btn"
            class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Submit
          </button>
        </div>
      </div>
    </div>

    <!-- Add character counter script -->
    <script>
      // Character counter for special instructions
      document.addEventListener("DOMContentLoaded", function () {
        const textarea = document.getElementById("special-instructions");
        const charCount = document.getElementById("char-count");

        if (textarea && charCount) {
          textarea.addEventListener("input", function () {
            charCount.textContent = this.value.length;
          });
        }

        // Mobile submit button
        const mobileSubmitBtn = document.getElementById("mobile-submit-btn");
        if (mobileSubmitBtn) {
          mobileSubmitBtn.addEventListener("click", function () {
            if (window.waiterNewOrder) {
              window.waiterNewOrder.submitOrder();
            }
          });
        }

        // Update mobile cart display
        const updateMobileCart = () => {
          const mobileCartCount = document.getElementById("mobile-cart-count");
          const mobileCartTotal = document.getElementById("mobile-cart-total");

          if (window.waiterNewOrder && mobileCartCount && mobileCartTotal) {
            const totalItems = window.waiterNewOrder.cart.reduce(
              (sum, item) => sum + item.quantity,
              0
            );
            const subtotal = window.waiterNewOrder.cart.reduce(
              (sum, item) => sum + item.price * item.quantity,
              0
            );
            const total = subtotal * 1.15;

            mobileCartCount.textContent = totalItems;
            mobileCartTotal.textContent = "ETB " + total.toFixed(2);

            // Update mobile submit button state
            const mobileSubmitBtn =
              document.getElementById("mobile-submit-btn");
            if (mobileSubmitBtn) {
              mobileSubmitBtn.disabled =
                !window.waiterNewOrder.selectedTableId ||
                window.waiterNewOrder.cart.length === 0;
            }
          }
        };

        // Observe cart changes
        setInterval(updateMobileCart, 1000);
      });
    </script>
  </body>
</html>
