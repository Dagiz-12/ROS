<!-- templates/admin_panel/menu_management.html -->
{% extends "admin_panel/admin_base.html" %}
{% load static %}

{% block title %}Menu Management - Restaurant Admin{% endblock %}

{% block page_title %}Menu Management{% endblock %}
{% block page_subtitle %}Organize your restaurant menu and track item performance{% endblock %}

{% block page_actions %}
<div class="flex items-center space-x-2">
    <button onclick="exportMenu()" class="btn-secondary">
        <i class="fas fa-download mr-2"></i>Export
    </button>
    <button onclick="importMenu()" class="btn-secondary">
        <i class="fas fa-upload mr-2"></i>Import
    </button>
    <button onclick="openAddItemModal()" class="btn-primary">
        <i class="fas fa-plus mr-2"></i>Add Item
    </button>
</div>
{% endblock %}

{% block content %}
{% csrf_token %}


<div class="space-y-6">
    <!-- Categories Section -->
    <div class="bg-white rounded-xl shadow-sm border p-6">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-lg font-bold text-gray-900">Categories</h2>
                <p class="text-sm text-gray-600">Organize your menu into categories</p>
            </div>
            <button onclick="openAddCategoryModal()" class="btn-primary">
                <i class="fas fa-plus mr-2"></i>Add Category
            </button>
        </div>

        <!-- Categories Grid -->
        <div id="categories-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for category in categories %}
            <div class="category-card border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-bold text-gray-900">{{ category.name }}</h3>
                        {% if category.description %}
                        <p class="text-sm text-gray-600 mt-1">{{ category.description|truncatechars:50 }}</p>
                        {% endif %}
                    </div>
                    <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">
                        {{ category.items.count }} items
                    </span>
                </div>
                
                <div class="flex items-center justify-between mt-4">
                    <div class="text-sm text-gray-500">
                        Order: {{ category.order_index }}
                        {% if not category.is_active %}
                        <span class="ml-2 px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">Inactive</span>
                        {% endif %}
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editCategory({{ category.id }})" 
                                class="text-blue-600 hover:text-blue-800 p-1">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteCategory({{ category.id }})" 
                                class="text-red-600 hover:text-red-800 p-1">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full text-center py-8">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-folder-open text-gray-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No Categories Found</h3>
                <p class="text-gray-600 mb-4">Create categories to organize your menu items</p>
                <button onclick="openAddCategoryModal()" class="btn-primary">
                    <i class="fas fa-plus mr-2"></i>Create First Category
                </button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Menu Items Section -->
    <div class="bg-white rounded-xl shadow-sm border p-6">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-lg font-bold text-gray-900">Menu Items</h2>
                <p class="text-sm text-gray-600">Manage your food and drink items</p>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- Filters -->
                <select id="category-filter" class="border rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                    <option value="all">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
                
                <select id="status-filter" class="border rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                    <option value="all">All Status</option>
                    <option value="available">Available</option>
                    <option value="unavailable">Unavailable</option>
                </select>
                
                <div class="relative">
                    <input type="text" id="search-items" 
                           class="border rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500" 
                           placeholder="Search items...">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>
        </div>

        <!-- Menu Items Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <input type="checkbox" id="select-all-items" class="rounded">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Item
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Price
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Cost
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Profit
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Sold
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Prep Time
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Description
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody id="menu-items-table" class="bg-white divide-y divide-gray-200">
                    {% for item in menu_items %}
                    <tr class="hover:bg-gray-50 transition-colors" data-category="{{ item.category.id }}" data-status="{{ item.is_available|yesno:'available,unavailable' }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="item-checkbox rounded" value="{{ item.id }}">
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                {% if item.image %}
                                <img src="{{ item.image.url }}" alt="{{ item.name }}" 
                                     class="w-10 h-10 rounded-lg object-cover mr-3">
                                {% else %}
                                <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-utensils text-gray-400"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <div class="font-medium text-gray-900">{{ item.name }}</div>
                                    {% if item.description %}
                                    <div class="text-sm text-gray-500 truncate max-w-xs">{{ item.description }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">
                                {{ item.category.name }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">
                            ${{ item.price|floatformat:2 }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-600">
                            {% if item.cost_price %}
                            ${{ item.cost_price|floatformat:2 }}
                            {% else %}
                            <span class="text-gray-400">Not set</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if item.cost_price and item.price > 0 %}
                            {% with profit=item.price|floatformat:2|add:"-"|add:item.cost_price|floatformat:2 %}
                            {% with margin=item.profit_margin|default:0 %}
                            <div class="flex items-center space-x-2">
                                <span class="font-medium {% if margin >= 50 %}text-green-600{% elif margin >= 30 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                    ${{ profit }}
                                </span>
                                <span class="text-xs px-2 py-1 rounded-full {% if margin >= 50 %}bg-green-100 text-green-800{% elif margin >= 30 %}bg-yellow-100 text-yellow-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ margin|floatformat:1 }}%
                                </span>
                            </div>
                            {% endwith %}
                            {% endwith %}
                            {% else %}
                            <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                {{ item.sold_count|default:0 }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full {% if item.is_available %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {{ item.is_available|yesno:"Available,Unavailable" }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex space-x-2">
                                <button onclick="editMenuItem({{ item.id }})" 
                                        class="text-blue-600 hover:text-blue-800 p-1"
                                        title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleItemStatus({{ item.id }})" 
                                        class="text-yellow-600 hover:text-yellow-800 p-1"
                                        title="{{ item.is_available|yesno:'Disable,Enable' }}">
                                    <i class="fas fa-power-off"></i>
                                </button>
                                <button onclick="viewItemPerformance({{ item.id }})" 
                                        class="text-green-600 hover:text-green-800 p-1"
                                        title="Performance">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                                <button onclick="deleteMenuItem({{ item.id }})" 
                                        class="text-red-600 hover:text-red-800 p-1"
                                        title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="px-6 py-8 text-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-utensils text-gray-400 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No Menu Items Found</h3>
                            <p class="text-gray-600 mb-4">Add your first menu item to get started</p>
                            <button onclick="openAddItemModal()" class="btn-primary">
                                <i class="fas fa-plus mr-2"></i>Add First Item
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Bulk Actions & Pagination -->
        <div class="mt-6 pt-6 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <select id="bulk-action" class="border rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="">Bulk Actions</option>
                        <option value="enable">Enable Selected</option>
                        <option value="disable">Disable Selected</option>
                        <option value="delete">Delete Selected</option>
                        <option value="move">Move to Category</option>
                    </select>
                    <button onclick="applyBulkAction()" class="btn-secondary">
                        Apply
                    </button>
                    <span id="selected-count" class="text-sm text-gray-600 hidden">
                        <span id="count">0</span> items selected
                    </span>
                </div>
                
                <div class="text-sm text-gray-600">
                    Showing {{ menu_items|length }} of {{ menu_items|length }} items
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Category Modal -->
<div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900" id="category-modal-title">
                Add New Category
            </h3>
        </div>
        
        <form id="category-form" class="p-6 space-y-4">
            
            <input type="hidden" id="category-id">
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Category Name *
                </label>
                <input type="text" id="category-name" required
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Description
                </label>
                <textarea id="category-description" rows="3"
                          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Order Index
                    </label>
                    <input type="number" id="category-order" min="0"
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Status
                    </label>
                    <select id="category-status" 
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
            </div>
        </form>
        
        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
            <button type="button" onclick="closeCategoryModal()" 
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                Cancel
            </button>
            <button type="button" onclick="saveCategory()" 
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                Save Category
            </button>
        </div>
    </div>
</div>

<!-- Add/Edit Menu Item Modal -->
<div id="menu-item-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900" id="menu-item-modal-title">
                Add New Menu Item
            </h3>
        </div>
        
        <form id="menu-item-form" class="p-6 space-y-6">
            
            <input type="hidden" id="menu-item-id">
            
            <!-- Basic Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Item Name *
                    </label>
                    <input type="text" id="item-name" required
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Category *
                    </label>
                    <select id="item-category" required
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                        <option value="">Select Category</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- Description -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Description
                </label>
                <textarea id="item-description" rows="3"
                          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500"
                          placeholder="Describe the item, ingredients, etc."></textarea>
            </div>
            
            <!-- Pricing & Cost -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Selling Price *
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-500">$</span>
                        <input type="number" id="item-price" required min="0" step="0.01"
                               class="w-full border border-gray-300 rounded-lg pl-8 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Cost Price
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-500">$</span>
                        <input type="number" id="item-cost" min="0" step="0.01"
                               class="w-full border border-gray-300 rounded-lg pl-8 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500"
                               placeholder="For profit calculation">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Ingredient cost per serving</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Preparation Time (minutes)
                    </label>
                    <input type="number" id="item-prep-time" min="1" max="120"
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500"
                           value="15">
                </div>
            </div>
            
            <!-- Profit Preview -->
            <div id="profit-preview" class="hidden p-4 bg-gray-50 rounded-lg">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Profit Preview</h4>
                <div class="grid grid-cols-3 gap-4">
                    <div class="text-center">
                        <div class="text-sm text-gray-500">Profit</div>
                        <div id="preview-profit" class="text-lg font-bold text-green-600">$0.00</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray-500">Margin</div>
                        <div id="preview-margin" class="text-lg font-bold text-green-600">0%</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray-500">Recommendation</div>
                        <div id="preview-recommendation" class="text-sm font-medium text-gray-700">-</div>
                    </div>
                </div>
            </div>
            
            <!-- Image Upload -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Item Image
                </label>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                    <div id="image-preview" class="mb-4">
                        <div class="w-32 h-32 bg-gray-200 rounded-lg flex items-center justify-center mx-auto">
                            <i class="fas fa-camera text-gray-400 text-2xl"></i>
                        </div>
                    </div>
                    <input type="file" id="item-image" accept="image/*" class="hidden">
                    <button type="button" onclick="document.getElementById('item-image').click()" 
                            class="btn-secondary">
                        <i class="fas fa-upload mr-2"></i>Upload Image
                    </button>
                    <p class="text-xs text-gray-500 mt-2">Recommended: 500x500px JPG or PNG</p>
                </div>
            </div>
            
            <!-- Status -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Availability
                </label>
                <div class="flex items-center">
                    <label class="inline-flex items-center mr-6">
                        <input type="radio" name="item-status" value="true" checked 
                               class="text-red-600 focus:ring-red-500">
                        <span class="ml-2">Available</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="item-status" value="false"
                               class="text-red-600 focus:ring-red-500">
                        <span class="ml-2">Unavailable</span>
                    </label>
                </div>
            </div>
        </form>
        
        <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
            <button type="button" onclick="closeMenuItemModal()" 
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                Cancel
            </button>
            <button type="button" onclick="saveMenuItem()" 
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                Save Item
            </button>
        </div>
    </div>
</div>

<!-- Performance Modal (placeholder) -->
<div id="performance-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <!-- Would show item performance charts -->
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Menu Management JavaScript -->
<script src="{% static 'js/admin/menu.js' %}"></script>
{% endblock %}